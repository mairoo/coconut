# 금액 추적 관리 시스템 설계 명세서

## 1. 시스템 개요

### 목표

회계 지식이 없는 사용자도 쉽게 사용할 수 있으면서, 정확한 잔액 추적과 거래 기록이 가능한 금액 관리 시스템을 구축한다.

### 핵심 원칙

- **단순성**: 전통적인 회계 분개의 복잡성(자산/부채/자본/수익/비용 구분, 차변/대변 균형) 제거
- **유연성**: 속성에 구애받지 않는 다양한 "바구니" 개념 도입
- **안정성**: 데이터 무결성과 성능 최적화 동시 달성

### 설계 철학

회계 분개 기록은 대차의 균형을 맞추면서 오류 가능성을 최소화하는 장치이지만, 회계 지식이 없는 엔드유저에게는 진입장벽이 높다. 본 시스템은 이러한 복잡성을 제거하고 직관적인 바구니 개념을 통해 누구나 쉽게 금액을
관리할 수 있도록 설계하되, 현재 상태값과 개별 거래 사실의 기록을 정확하게 유지한다.

## 2. 핵심 엔티티 설계

### 2.1 주인(Owner) 엔티티

- **정의**: 여러 개의 바구니를 소유할 수 있는 주체
- **범위**: 개인, 법인, 조직 등 모든 형태의 금액 관리 주체
- **특징**: 엔티티가 여러 금액의 바구니를 가질 수 있는 구조

### 2.2 바구니(Basket) 엔티티

- **정의**: 금액을 담는 논리적 컨테이너
- **특징**: 속성으로부터 자유로운 바구니를 다양하게 생성 가능
- **관리방식**: enum 값을 통한 표준화된 타입 관리
- **예시**: 현금, 예금, 적금, 투자, 용돈, 식비, 교통비, 쇼핑비 등

### 2.3 거래(Transaction) 엔티티

- **정의**: 바구니 간 또는 바구니와 외부 간의 금액 이동 기록
- **구성**: 각 거래는 하나 이상의 바구니 변동을 포함
- **추적성**: 모든 금액 변동의 원인과 결과를 명확히 기록

## 3. 데이터 저장 구조 설계

### 3.1 현재 상태값 관리 방식

현재 상태값의 관리에서 유념해야 할 것은 값의 무결성이다.

#### 구조 설계 비교 분석

**1안 (비정규화된 Wide Table)**: `주인 ID | 바구니1 | 바구니2 | 바구니3 | ...`

**장점**:

- 주인의 모든 바구니 현재 값을 하나의 레코드로 어떤 조인도 없이 빠르게 조회 가능
- 단일 레코드 업데이트로 여러 바구니 동시 변경 가능
- 메모리 지역성 우수 - 관련 데이터가 물리적으로 인접

**단점**:

- 바구니가 늘어나거나 줄어들 때마다 ALTER TABLE로 필드 추가/삭제 필요 (매우 비싼 연산)
- 거래 무결성 보장을 위한 락 시 사용하지 않는 바구니까지 잠금 (락 오버헤드 발생)
- NULL 값이 많은 sparse table 문제
- DB 스키마 구조 변경의 운영 부담

**2안 (EAV 패턴 또는 정규화된 Key-Value 구조)**: `주인 ID | 바구니 enum 값 | 현재잔액`

**장점**:

- DB 스키마 구조 변경 없이 동적으로 바구니를 늘리고 줄일 수 있음
- 거래 무결성을 위한 레코드 락 시 바구니별 독립적 처리 (바구니1 금액 변경이 바구니2에 영향 없음)
- enum 값 사용으로 데이터 일관성 보장 및 성능 최적화
- 정규화된 구조로 데이터 품질 향상

**단점**:

- 주인의 모든 바구니 값을 조회하려면 JOIN 횟수가 늘어남
- 여러 주인 목록과 모든 바구니 값을 표로 출력 시 쿼리 복잡성 증가

#### 채택 방안: 2안 + 단계별 최적화 전략

**최종 구조**: `주인 ID | 바구니 enum 값 | 현재잔액`

**선택 근거**: 확장성과 동시성의 장점이 복잡성 단점을 상쇄

**테이블 형태 조회 최적화 전략**:

바구니 개수별 단계적 접근으로 2안의 단점 해결:

- **5개 이하**: 핵심 모니터링 바구니만 JOIN (성능 부담 없음)
- **6~20개**: 하이브리드 방식 (핵심은 JOIN, 나머지는 별도 처리)
- **21개 이상**: Materialized View + 애플리케이션 레벨 처리

### 3.2 거래 사실 기록 구조

#### 이벤트 소싱 패턴 적용

거래 개별 사실을 기록하는 핵심은 **중복과 누락의 문제** 해결이다.

**설계 철학**: 모든 금액 변동을 불변의 이벤트로 기록하고, 현재 상태는 이벤트들의 순차적 적용을 통해 도출한다.

#### 거래 이벤트 저장소 구조

**이벤트 테이블**: `이벤트ID | 거래ID | 주인ID | 바구니enum | 변동금액 | 시점 | 이벤트상태 | 메타데이터`

**핵심 요소**:

- **시점**: 거래 발생 시각
- **변동**: 금액 증감량
- **잔액**: 거래 후 누적 잔액

#### 바구니별 분리 테이블 전략

공통 요소를 하나의 테이블에 모두 넣으면 레코드가 폭발적으로 증가하므로, 바구니별로 테이블을 나누어 최소한 주인 참조와 시점, 변동, 금액만 저장한다.

**구조**: `바구니타입별_거래내역(주인ID, 시점, 변동금액, 거래후잔액, 거래ID)`

**장점**:

- 테이블 크기 분산으로 성능 향상
- 바구니별 독립적인 인덱싱 및 파티셔닝 가능
- 업데이트 레코드 개수 최소화로 성능 최적화

## 4. 이벤트 소싱 기반 무결성 보장

### 4.1 거래 멱등성 구현

**중복 문제 해결**: 거래의 멱등성 보장

**구현 방식**:

- 고유 거래ID를 통한 중복 실행 방지
- 동일 거래 재실행 시 동일한 결과 보장
- 거래 상태 추적 (대기/진행중/완료/실패/보상)

**이벤트 소싱의 멱등성 장점**:

- 네트워크 재시도, 시스템 장애 시에도 안전
- 부분 실패 시 정확한 복구 가능

### 4.2 이벤트 재생을 통한 누락 방지

**누락 문제 해결**: 거래 이후 잔액을 모두 업데이트

**구현 방식**:

- 이벤트 재생(Event Replay)을 통한 잔액 재계산
- 거래 순서 보장을 위한 이벤트 ID 시퀀스 관리
- 영향받는 거래 범위 최소화로 성능 최적화

**재계산 최적화**:

- 스냅샷 기능으로 전체 재계산 회피
- 일 단위 마감 처리 개념으로 재계산 범위 제한
- 증분 업데이트 전략 적용

### 4.3 이벤트 소싱의 추가 이점

#### 완전한 감사 추적

- 모든 금액 변동의 완전한 이력 보존
- 시점별 잔액 복원 가능 (시간 여행 쿼리)
- 규제 요구사항 완벽 대응

#### 보상 트랜잭션 지원

- 잘못된 거래에 대한 보상 이벤트 생성
- 시스템 복구 시 안전한 롤백 메커니즘

#### 성능 최적화 전략

- 이벤트 압축을 통한 스토리지 최적화
- 비동기 투영으로 읽기 성능 향상
- 스냅샷 기반 점진적 재계산

## 5. 기술적 고려사항

### 5.1 동시성 제어

- **바구니별 독립적 잠금**: 레코드 단위 락으로 동시성 극대화
- **낙관적 잠금**: 충돌 가능성이 낮은 경우 성능 최적화
- **데드락 방지**: 잠금 순서 표준화 및 타임아웃 관리

### 5.2 확장성 대응

- **주인 기준 샤딩**: 수평적 확장 전략
- **바구니별 분산**: 타입별 독립적인 확장
- **읽기 복제본**: 조회 성능 향상을 위한 복제 전략

### 5.3 백업 및 복구

- **이벤트 기반 복구**: 거래 로그를 통한 정확한 상태 복원
- **시점별 스냅샷**: 빠른 복구를 위한 정기적 스냅샷
- **데이터 무결성 검증**: 자동화된 정합성 검사

### 5.4 보안 및 감사

- **주인별 접근 제어**: 데이터 접근 권한 엄격 관리
- **암호화**: 금융 데이터 보호를 위한 암호화 저장
- **감사 로그**: 모든 접근 및 변경 사항 추적

## 6. 구현 전략

### 6.1 enum 확장성 관리

- **하위 호환성**: enum 값 변경 시 기존 데이터 보호
- **동적 확장**: 새로운 바구니 타입 추가 시 무중단 배포
- **사용자 정의**: 표준 타입과 사용자 정의 타입의 하이브리드 지원

### 6.2 성능 모니터링

- **쿼리 최적화**: 실행 계획 분석을 통한 지속적 개선
- **부하 테스트**: 대용량 거래 처리 성능 검증
- **실시간 메트릭**: 핵심 성능 지표 모니터링

### 6.3 사용자 경험 최적화

- **즉시 피드백**: 모든 거래에 대한 실시간 반영
- **직관적 인터페이스**: 회계 지식 없이도 사용 가능한 UI/UX
- **오류 복구**: 사용자 친화적인 오류 처리 및 복구 가이드

## 결론

이러한 설계를 통해 회계 전문 지식 없이도 직관적으로 사용할 수 있으면서, 이벤트 소싱의 강력한 무결성 보장과 확장 가능한 아키텍처를 갖춘 금액 추적 관리 시스템을 구축할 수 있다. 핵심은 바구니 개념의 단순함과
이벤트 소싱의 안정성을 조화시켜 사용자에게는 쉽게, 시스템에게는 견고하게 작동하는 것이다.